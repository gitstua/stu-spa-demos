<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTB Trails</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        main {
            display: flex;
            padding: 20px;
        }

        #map {
            width: 70%;
            height: 500px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            float: left;
            position: relative;
            cursor: crosshair;
        }

        #map.grabbing {
            cursor: grabbing;
        }

        .map-search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 300px;
        }

        .map-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            white-space: nowrap;
        }

        .map-hint .action {
            color: #5bf;
            font-weight: bold;
        }

        #map:hover .map-hint {
            opacity: 1;
        }

        aside {
            width: 30%;
            height: 80vh;
            margin: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            padding: 20px;
            float: right;
        }

        .floating-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            padding: 10px;
            text-align: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        .trail-marker {
            font-size: 24px;
            color: red;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        li:hover {
            background-color: #f0f0f0;
        }

        li.selected {
            background-color: #e0e0e0;
        }

        .edit-button, .delete-button {
            margin-right: 10px;
            padding: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }

        .edit-button {
            background-color: #007bff;
            color: white;
        }

        .delete-button {
            background-color: #dc3545;
            color: white;
        }

        .name-span {
            flex-grow: 1;
        }

        .leaflet-control-geocoder-form input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .leaflet-control-geocoder-form button {
            padding: 5px 10px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .leaflet-control-geocoder-form button:hover {
            background-color: #0056b3;
        }

        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            position: absolute;
            right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            padding: 0;
            margin: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-results div {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-results div:hover {
            background-color: #f0f0f0;
        }

        .search-results div:focus,
        .search-results div.focused {
            background-color: #007bff;
            color: white;
            outline: none;
        }

        .search-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
            min-height: 1.2em;
        }

        .hidden {
            display: none;
        }

        #search-input {
            width: 100%;
            padding: 8px 30px 8px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-container {
            display: none;
        }

        .button-container {
            position: fixed;
            right: 20px;
            bottom: 60px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .icon-button:hover {
            transform: scale(1.1);
            background-color: #0056b3;
        }

        .icon-button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        @media (max-width: 600px) {
            .button-container {
                bottom: 50px;
                right: 10px;
            }

            .icon-button {
                width: 35px;
                height: 35px;
            }
        }

        /* Add these new mobile-friendly styles */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
                padding: 10px;
            }

            #map {
                width: 100%;
                height: 60vh;
                margin: 10px 0;
            }

            aside {
                width: 100%;
                height: auto;
                max-height: 40vh;
                margin: 10px 0;
            }

            .map-search-container {
                width: calc(100% - 40px);
                top: 10px;
                right: 10px;
                left: 10px;
            }

            #search-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px;
            }

            .map-hint {
                font-size: 12px;
                padding: 8px 16px;
            }

            .edit-button, .delete-button {
                padding: 8px;
                margin-right: 8px;
                min-width: 44px; /* Minimum touch target size */
                min-height: 44px;
            }

            li {
                padding: 12px 8px;
            }

            .floating-footer {
                font-size: 12px;
                padding: 8px;
            }

            .icon-button {
                width: 48px; /* Larger touch target */
                height: 48px;
            }

            .button-container {
                bottom: 70px;
            }
        }

        /* Additional touch-friendly improvements */
        @media (hover: none) {
            .map-hint {
                opacity: 1;
                background: rgba(0, 0, 0, 0.9);
            }

            li:active {
                background-color: #e0e0e0;
            }

            .icon-button:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="/">Back to Home</a>
    </header>
    <main>
        <div id="map">
            <div class="map-hint">
                <span class="action">🎯 Click</span> to add a ride • <span class="action">✋ Drag</span> to move map
            </div>
            <div class="map-search-container">
                <label for="search-input">Search for a location</label>
                <div class="search-wrapper">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Search location on map..." 
                        aria-describedby="search-status"
                        autocomplete="off"
                    >
                    <div class="spinner" id="search-spinner" role="status" aria-hidden="true"></div>
                </div>
                <div id="search-status" class="search-status" role="status"></div>
                <div id="search-results" class="search-results" role="listbox" tabindex="-1"></div>
            </div>
        </div>
        <aside>
            <h2>Rides</h2>
            <ul id="rides-list"></ul>
        </aside>
    </main>
    <div class="button-container">
        <button class="icon-button" id="copyButton" title="Copy URL">
            <svg viewBox="0 0 24 24">
                <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/>
            </svg>
        </button>
        <button class="icon-button" id="copyTextButton" title="Copy as Text">
            <svg viewBox="0 0 24 24">
                <path d="M17,9H7V7H17M17,13H7V11H17M14,17H7V15H14M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3Z"/>
            </svg>
        </button>
    </div>
    <footer class="floating-footer">
        Made with ❤️ by Stu at <a href="https://github.com/gitstua/stu-spa-demos">github.com/gitstua/stu-spa-demos</a> using GitHub Copilot - Version 19
    </footer>
    <section>
        <p>This SPA allows you to select a location on the map and view the trails you want to do. You can also save your favorite trails and view them in the side pane.</p>
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mapElement = document.getElementById('map');
            const ridesList = document.getElementById('rides-list');
            let map;
            let markers = [];

            function initializeMap() {
                map = L.map(mapElement, {
                    zoomControl: false, // Remove default zoom control
                    tap: true // Enable tap handler for mobile
                }).setView([51.505, -0.09], 13);

                // Add zoom control to top-right
                L.control.zoom({
                    position: 'topright'
                }).addTo(map);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                map.on('click', onMapClick);
            }

            // Update map click handler to check if click is on search container
            function onMapClick(e) {
                // Check if click target is search container or its children
                const searchContainer = document.querySelector('.map-search-container');
                if (e.originalEvent.target.closest('.map-search-container')) {
                    return; // Exit if click is on search container
                }

                const trail = prompt('Enter trail name:');
                if (trail) {
                    addRide(trail, e.latlng.lat, e.latlng.lng);
                    const marker = L.marker([e.latlng.lat, e.latlng.lng], { icon: L.divIcon({ className: 'trail-marker', html: '🚴' }) }).addTo(map);
                    markers.push(marker);
                }
            }

            function addRide(name, lat, lng) {
                const li = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name;
                nameSpan.className = 'name-span';
                
                const editButton = document.createElement('button');
                editButton.textContent = '✏️';
                editButton.className = 'edit-button';
                editButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newName = prompt('Edit trail name:', nameSpan.textContent);
                    if (newName) {
                        nameSpan.textContent = newName;
                        saveRides();
                    }
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = '🗑️';
                deleteButton.className = 'delete-button';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to delete this ride?')) {
                        li.remove();
                        saveRides();
                    }
                });

                li.appendChild(editButton);
                li.appendChild(deleteButton);
                li.appendChild(nameSpan);
                li.dataset.lat = lat;
                li.dataset.lng = lng;
                ridesList.appendChild(li);
                saveRides();
            }

            function loadRides() {
                try {
                    const fragment = window.location.hash.substring(1);
                    if (!fragment) return;
                    
                    // Decompress and parse the fragment
                    const decompressed = LZString.decompressFromEncodedURIComponent(fragment);
                    if (!decompressed) return;
                    
                    const rides = JSON.parse(decompressed);
                    rides.forEach(trail => {
                        addRide(trail.name, trail.lat, trail.lng);
                    });
                } catch (error) {
                    console.error('Error loading rides:', error);
                    // Optional: Show error to user
                    alert('Error loading rides data. Starting fresh.');
                    window.location.hash = '';
                }
            }

            function saveRides() {
                const rides = Array.from(ridesList.children).map(li => ({
                    name: li.querySelector('span').textContent,
                    lat: li.dataset.lat,
                    lng: li.dataset.lng
                }));
                
                // Compress the rides data
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(rides));
                window.location.hash = compressed;
            }

            ridesList.addEventListener('click', (event) => {
                const li = event.target.closest('li');
                if (li) {
                    const lat = li.dataset.lat;
                    const lng = li.dataset.lng;
                    map.setView([lat, lng], 13);
                    document.querySelectorAll('#rides-list li').forEach(li => li.classList.remove('selected'));
                    li.classList.add('selected');
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    const marker = L.marker([lat, lng], { icon: L.divIcon({ className: 'trail-marker', html: '🚴' }) }).addTo(map);
                    markers.push(marker);
                }
            });

            // Replace search functionality with location search
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const searchStatus = document.getElementById('search-status');
            const searchSpinner = document.getElementById('search-spinner');
            let searchTimeout;
            let selectedIndex = -1;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchResults.innerHTML = '';
                searchSpinner.style.display = 'none';
                selectedIndex = -1;
                
                if (e.target.value.length < 3) {
                    searchStatus.textContent = e.target.value.length > 0 ? 
                        'Please enter at least 3 characters' : '';
                    return;
                }

                searchSpinner.style.display = 'block';
                searchStatus.textContent = 'Searching...';

                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e.target.value)}`);
                        const data = await response.json();
                        
                        searchSpinner.style.display = 'none';
                        searchResults.innerHTML = '';
                        
                        if (data.length === 0) {
                            searchStatus.textContent = 'No results found';
                            return;
                        }

                        searchStatus.textContent = `${data.length} locations found`;
                        
                        data.slice(0, 5).forEach((place, index) => {
                            const div = document.createElement('div');
                            div.textContent = place.display_name;
                            div.setAttribute('role', 'option');
                            div.setAttribute('tabindex', '0');
                            div.setAttribute('aria-selected', 'false');
                            
                            div.addEventListener('click', () => selectLocation(place));
                            div.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    selectLocation(place);
                                }
                            });
                            searchResults.appendChild(div);
                        });
                    } catch (error) {
                        console.error('Error searching for location:', error);
                        searchStatus.textContent = 'Error searching for location';
                        searchSpinner.style.display = 'none';
                    }
                }, 500);
            });

            function selectLocation(place) {
                map.setView([place.lat, place.lon], 13);
                searchResults.innerHTML = '';
                searchInput.value = place.display_name;
                searchStatus.textContent = 'Location selected';
            }

            searchInput.addEventListener('keydown', (e) => {
                const results = searchResults.children;
                if (results.length === 0) return;

                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    
                    // Remove focus from current item
                    if (selectedIndex >= 0) {
                        results[selectedIndex].classList.remove('focused');
                        results[selectedIndex].setAttribute('aria-selected', 'false');
                    }

                    // Calculate new index
                    if (e.key === 'ArrowDown') {
                        selectedIndex = selectedIndex < results.length - 1 ? selectedIndex + 1 : 0;
                    } else {
                        selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : results.length - 1;
                    }

                    // Focus new item
                    results[selectedIndex].classList.add('focused');
                    results[selectedIndex].setAttribute('aria-selected', 'true');
                    results[selectedIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    results[selectedIndex].click();
                } else if (e.key === 'Escape') {
                    searchResults.innerHTML = '';
                    searchStatus.textContent = '';
                    selectedIndex = -1;
                }
            });

            // Hide search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchResults.contains(e.target) && e.target !== searchInput) {
                    searchResults.innerHTML = '';
                    searchStatus.textContent = '';
                }
            });

            // Update search box event handlers to stop propagation
            const searchContainer = document.querySelector('.map-search-container');
            searchContainer.addEventListener('mousedown', (e) => {
                e.stopPropagation();
            });

            searchInput.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            searchResults.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Add mousedown/mouseup handlers for grab cursor
            mapElement.addEventListener('mousedown', () => {
                mapElement.classList.add('grabbing');
            });

            document.addEventListener('mouseup', () => {
                mapElement.classList.remove('grabbing');
            });

            // Add touch event handlers
            let touchTimeout;
            mapElement.addEventListener('touchstart', () => {
                touchTimeout = setTimeout(() => {
                    mapElement.classList.add('grabbing');
                }, 200);
            });

            mapElement.addEventListener('touchend', () => {
                clearTimeout(touchTimeout);
                mapElement.classList.remove('grabbing');
            });

            // Add copy button functionality
            const copyButton = document.getElementById('copyButton');
            copyButton.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = `<svg viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>`;
                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                    }, 2000);
                } catch (err) {
                    alert('Failed to copy URL');
                }
            });

            // Add copy text button functionality
            const copyTextButton = document.getElementById('copyTextButton');
            copyTextButton.addEventListener('click', async () => {
                try {
                    const rides = Array.from(ridesList.children).map(li => ({
                        name: li.querySelector('.name-span').textContent,
                        lat: li.dataset.lat,
                        lng: li.dataset.lng
                    }));

                    const textContent = rides
                        .map(ride => `${ride.name} (${Number(ride.lat).toFixed(4)}, ${Number(ride.lng).toFixed(4)})`)
                        .join('\n');

                    await navigator.clipboard.writeText(textContent);
                    const originalHTML = copyTextButton.innerHTML;
                    copyTextButton.innerHTML = `<svg viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>`;
                    setTimeout(() => {
                        copyTextButton.innerHTML = originalHTML;
                    }, 2000);
                } catch (err) {
                    alert('Failed to copy text');
                }
            });

            initializeMap();
            loadRides();
        });
    </script>
</body>
</html>
