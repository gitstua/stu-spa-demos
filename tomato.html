<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f4f4f4;
        }
        h1 {
            display: flex;
            align-items: baseline;
            gap: 15px;
            margin-bottom: 20px;
        }
        #timer {
            font-size: 56px;
            transition: font-size 0.3s ease;
        }
        .running #timer {
            font-size: 90px;
        }
        button, input, select {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
        .time-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .time-entry label {
            margin-bottom: 5px;
        }
        .time-entry select {
            min-width: 170px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            padding: 10px;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            background-color: #004494;
        }
        .nav-link {
            position: fixed;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: #666;
            font-size: 16px;
        }
        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .usage-note {
            margin-top: 40px;
            font-size: 14px;
            color: #555;
            text-align: center;
        }
    </style>
</head>
<body>
    <a href="index.html" class="nav-link">← Back to Index</a>
    <h1>Pomodoro Timer <span id="timer">10:00</span></h1>
    <div class="time-entry">
        <label for="minutesSelect">Minutes</label>
        <select id="minutesSelect">
            <option value="2">2</option>
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
        </select>
    </div>
    <button id="toggleButton" onclick="toggleTimer()">Start</button>
    <button onclick="resetTimer()">Reset</button>
    <div class="controls-row">
        <label>
            <input type="checkbox" id="keepAwakeCheckbox" checked>
            Keep screen on
        </label>
    </div>
    <audio id="alarmSound" src="TempleBell-SoundBible.com-756181215.mp3" preload="auto"></audio>
    <p class="usage-note">
        Tip: Bookmark custom times with query params, e.g. <code>?minutes=7&amp;seconds=30</code>.
    </p>

    <script>
        const minutesSelect = document.getElementById('minutesSelect');
        const toggleButton = document.getElementById('toggleButton');
        const keepAwakeCheckbox = document.getElementById('keepAwakeCheckbox');
        let timer;
        let minutes = 10;
        let seconds = 0;
        let baseMinutes = 10;
        let baseSeconds = 0;
        let isRunning = false;
        let wakeLock;

        function setSelectValue(value) {
            const existingOption = Array.from(minutesSelect.options).find(opt => parseInt(opt.value, 10) === value);
            if (existingOption) {
                minutesSelect.value = String(value);
                return;
            }
            const customOption = document.createElement('option');
            customOption.value = String(value);
            customOption.textContent = `${value} (custom)`;
            minutesSelect.appendChild(customOption);
            minutesSelect.value = String(value);
        }

        function initializeFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const queryMinutes = parseInt(params.get('minutes'), 10);
            const querySeconds = parseInt(params.get('seconds'), 10);
            if (!Number.isNaN(queryMinutes)) {
                baseMinutes = Math.max(0, queryMinutes);
            }
            setSelectValue(baseMinutes);
            minutes = baseMinutes;
            if (!Number.isNaN(querySeconds)) {
                baseSeconds = Math.min(59, Math.max(0, querySeconds));
            }
            seconds = baseSeconds;
        }

        function updateDisplay() {
            const formatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer').textContent = formatted;
            document.title = isRunning ? `${formatted} • Pomodoro Timer` : 'Pomodoro Timer';
        }

        function syncTimerFromControls() {
            baseMinutes = parseInt(minutesSelect.value, 10) || 0;
            minutes = baseMinutes;
            seconds = baseSeconds;
            updateDisplay();
        }

        async function requestWakeLock() {
            if (!keepAwakeCheckbox.checked) {
                releaseWakeLock();
                return;
            }
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        wakeLock = null;
                    });
                }
            } catch (err) {
                console.warn('Wake Lock request failed', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        async function toggleTimer() {
            if (isRunning) {
                stopTimer();
                return;
            }
            syncTimerFromControls();
            isRunning = true;
            document.body.classList.add('running');
            toggleButton.textContent = 'Stop';
            requestWakeLock();
            timer = setInterval(() => {
                if (seconds === 0) {
                    if (minutes === 0) {
                        stopTimer();
                        document.getElementById('alarmSound').play();
                        alert("Time's up!");
                    } else {
                        minutes--;
                        seconds = 59;
                    }
                } else {
                    seconds--;
                }
                updateDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
            isRunning = false;
            document.body.classList.remove('running');
            toggleButton.textContent = 'Start';
            releaseWakeLock();
        }

        function resetTimer() {
            clearInterval(timer);
            isRunning = false;
            minutes = baseMinutes;
            seconds = baseSeconds;
            setSelectValue(minutes);
            toggleButton.textContent = 'Start';
            document.body.classList.remove('running');
            releaseWakeLock();
            updateDisplay();
        }

        initializeFromQuery();
        minutesSelect.addEventListener('change', () => {
            if (isRunning) return;
            syncTimerFromControls();
        });
        keepAwakeCheckbox.addEventListener('change', () => {
            if (keepAwakeCheckbox.checked && isRunning) {
                requestWakeLock();
            } else {
                releaseWakeLock();
            }
        });
        updateDisplay();
    </script>
</body>
</html>
